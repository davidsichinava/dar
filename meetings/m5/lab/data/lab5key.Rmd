---
title: "მეხუთე ლაბორატორია"
output: html_notebook
---

```{r}
library(tidyverse)
library(haven)
```

წავიკითხოთ მონაცემები

```{r}
setwd("D:\\Dropbox\\My projects\\Courses\\ST_R\\website\\meetings\\m7\\lab\\data")
idahot <- read_dta("May17_Only_responses_10072013.dta")
idahot[] <- lapply(idahot, unclass)
```

რა არის ამოცანა: შევადგინოთ "სოციალური კონსერვატიზმის ინდექსი" მე-16 კითხვის გამოყენებით

```{r}
recodeVal <- function(x) {
  x <- dplyr::recode(x, `-1`=1, `-2`=1)
  x <-dplyr::na_if(x, -9)
  x <-dplyr::na_if(x, -3)
}

idahot$d16_1 <- recodeVal(idahot$d16_1)
idahot$d16_2 <- recodeVal(idahot$d16_2)
idahot$d16_3 <- recodeVal(idahot$d16_3)
idahot$d16_4 <- recodeVal(idahot$d16_4)
idahot$d16_5 <- recodeVal(idahot$d16_5)
idahot$d16_6 <- recodeVal(idahot$d16_6)

idahot$d16_index <- idahot$d16_1+idahot$d16_2+idahot$d16_3+
  idahot$d16_4+idahot$d16_5+idahot$d16_6
summary(idahot$d16_index)


```

შევადგინოთ უმცირესობებისადმი პატივისცემის ინდექსი

```{r}
recodeAcc <- function(x) {
  x <- dplyr::recode(x, `-1`=3, `-2`=3, `3`=4, `4`=5)
  x <-dplyr::na_if(x, -9)
  x <-dplyr::na_if(x, -3)
}

idahot$q8_2 <- recodeVal(idahot$q8_2)
idahot$q8_3 <- recodeVal(idahot$q8_3)
idahot$q8_4 <- recodeVal(idahot$q8_4)


idahot$minorities <- idahot$q8_2+idahot$q8_3+idahot$q8_4
summary(idahot$minorities)

```

შევადგინოთ ჰომოფობიური დამოკიდებულების ცვლადი, რომელიც გაიზომება მე-7 კითხვით (ვის არ ისურვებდით მეზობლად)

შევადგინოთ განათლების ბინარული ცვლადი (არასრული უმაღლესი+, უფრო დაბალი)

```{r}

idahot$homophobia <- 0
idahot$homophobia[idahot$q7 == 5] <- 1
table(idahot$homophobia)

idahot$education <- 0
idahot$education[idahot$d4 >  3] <- 1
table(idahot$education)

```

არის თუ არა კორელაცია  სოციალურ კონსერვატიზმსა და ასაკს შორის?

არის თუ არა კორელაცია  სოციალურ კონსერვატიზმსა და  უმცირესობების პატივისცემას შორის?


განსხვავდებიან თუ არა ქალები და კაცები სოციალური კონსერვატიზმის მიხედვით?

განსხვავდებიან თუ არა სოციალური კონსერვატიზმის მიხედვით ჰომოფობები და არაჰომოფობები

განსხვავდებიან თუ არა უმცირესობებისადმი დამოკიდებულების მიხედვით ჰომოფობები და არაჰომოფობები


```{r}

  cor(idahot$d16_index, idahot$d2,method="spearman",use="complete.obs")

cor(idahot$d16_index, idahot$minorities,method="spearman",use="complete.obs")

t.test(idahot$d16_index, idahot$d1)
t.test(idahot$minorities, idahot$d1)


mean(idahot$d16_index[idahot$d1 == 1])
mean(idahot$d16_index[idahot$d1 == 2], na.rm=TRUE)

mean(idahot$minorities[idahot$d1 == 1])
mean(idahot$minorities[idahot$d1 == 2], na.rm=TRUE)

t.test(idahot$d16_index, idahot$homophobia)
t.test(idahot$minorities, idahot$homophobia)

t.test(idahot$d16_index, idahot$education)
t.test(idahot$minorities, idahot$education)

chisq.test(idahot$homophobia, idahot$education)

```


ვიზუალიზაცია: 
  ა)კონსერვატიზმის ინდექსი სქესის მიხედვით
  ბ) ჰომოფობია განათლების და სქესის მიხედვით

```{r}

idahot$homophobia <- factor(idahot$homophobia, levels =c(0, 1), labels= c("Yes", "No"))

idahot$d1 <- factor(idahot$d1, levels =c(1, 2), labels= c("კაცი", "ქალი"))

idahot$education <- factor(idahot$education, levels =c(0, 1), labels= c("უმაღლესზე დაბალი", "სრული ან არასრული უმაღლესი"))

ggplot(idahot, aes(homophobia, y = ..prop.., group = 1))+
  geom_bar(aes(weight=indwt, color=homophobia), stat="count")+
  theme_minimal()+
  facet_wrap(~d1)+
  labs(title="ვის არ ისურვებდით მეზობლად?",
       subtitle="ჰომოსექსუალებს",
       caption="გამოკითხვა 2013 წლის 17 მაისის მოვლენების შესახებ")



```

```{r}
ggplot(idahot, aes(homophobia, y = ..prop.., group = 1))+
  geom_bar(aes(weight=indwt, color=homophobia), stat="count")+
  theme_minimal()+
  facet_wrap(~education)+
  labs(title="ვის არ ისურვებდით მეზობლად?",
       subtitle="ჰომოსექსუალებს",
       caption="გამოკითხვა 2013 წლის 17 მაისის მოვლენების შესახებ")

```


კლასტერული ანალიზი განათლების მიხედვით

```{r}

lower <- cbind(idahot$d16_index[idahot$education == 0],
                 idahot$minorities[idahot$education == 0])
higher <- cbind(idahot$d16_index[idahot$education == 1],
                  idahot$minorities[idahot$education == 1])
lower[is.na(lower)] <- mean(lower, na.rm=TRUE)

lower.out <- kmeans(lower, centers = 2, nstart = 2)
higher.out <- kmeans(higher, centers = 2, nstart = 5)

prop.table(table(gender = idahot$d1[idahot$education == 0],
        cluster = lower.out$cluster))

prop.table(table(gender = idahot$d1[idahot$education == 1],
        cluster = higher.out$cluster))


```


